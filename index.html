<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SemRosto</title>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#0f0f0f;
  color:#fff;
}

.hidden { display:none; }

.card {
  background:#1b1b1b;
  padding:20px;
  margin:20px;
  border-radius:10px;
}

input, textarea, button {
  width:100%;
  padding:10px;
  margin-top:10px;
  border:none;
  border-radius:6px;
}

button {
  background:#6a5acd;
  color:#fff;
  cursor:pointer;
}

.menu {
  position:fixed;
  left:0;
  top:0;
  width:60px;
  height:100%;
  background:#000;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding-top:10px;
}

.menu button {
  width:40px;
  margin:10px 0;
  font-size:18px;
}

#chat {
  height:300px;
  overflow-y:auto;
  border:1px solid #333;
  padding:10px;
}

.msg {
  margin:5px 0;
}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro" class="card">
  <h2>SemRosto</h2>
  <p>
    Goste de quem a pessoa √©,<br>
    n√£o de como ela parece.<br><br>
    Aqui voc√™ conversa primeiro.<br>
    Apar√™ncia nunca vem antes da conex√£o.
  </p>
  <button onclick="intro.classList.add('hidden')">Entendi</button>
</div>

<!-- MENU -->
<div class="menu hidden" id="menu">
  <button onclick="mostrar('perfil')">üë§</button>
  <button onclick="mostrar('usuarios')">üí¨</button>
  <button onclick="mostrar('pix')">‚ù§Ô∏è</button>
</div>

<!-- AUTH -->
<div id="auth" class="card">
  <h3>Entrar ou criar conta</h3>
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- PERFIL -->
<div id="perfil" class="card hidden">
  <h3>Seu perfil</h3>
  <input id="nome" placeholder="Seu nome">
  <textarea id="interesses" placeholder="O que voc√™ gosta?"></textarea>
  <textarea id="dia" placeholder="Como foi seu dia?"></textarea>
  <button onclick="salvarPerfil()">Salvar</button>
</div>

<!-- USU√ÅRIOS -->
<div id="usuarios" class="card hidden">
  <h3>Pessoas</h3>
  <div id="listaUsuarios"></div>
</div>

<!-- CHAT -->
<div id="chatBox" class="card hidden">
  <h3 id="chatTitulo"></h3>
  <div id="chat"></div>
  <input id="mensagem" placeholder="Digite sua mensagem">
  <button onclick="enviarMensagem()">Enviar</button>
</div>

<!-- PIX -->
<div id="pix" class="card hidden">
  <h3>Ajudar o desenvolvedor ‚ù§Ô∏è</h3>
  <p>
    Esse projeto √© independente.<br>
    Se quiser apoiar, envie qualquer valor via Pix.
  </p>
  <p><b>Chave Pix:</b><br>23be4842-00bd-4969-85e3-e45da27ffc03</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, query, orderBy, onSnapshot } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBm7uwLhsmQsCqgwm1SucUBN24-IbkOayM",
  authDomain: "semrosto-70293.firebaseapp.com",
  projectId: "semrosto-70293",
  storageBucket: "semrosto-70293.firebasestorage.app",
  messagingSenderId: "1092743054662",
  appId: "1:1092743054662:web:5765e25536cdfec825d147"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let usuarioAtual = null;
let chatId = null;

window.mostrar = (id) => {
  ["perfil","usuarios","chatBox","pix"].forEach(x => document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
};

window.login = async () => {
  try {
    await signInWithEmailAndPassword(auth, email.value, senha.value);
  } catch {
    await createUserWithEmailAndPassword(auth, email.value, senha.value);
  }
};

onAuthStateChanged(auth, async user => {
  if (user) {
    usuarioAtual = user;
    auth.classList.add("hidden");
    menu.classList.remove("hidden");

    const ref = doc(db, "usuarios", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) mostrar("perfil");
    else carregarUsuarios();
  }
});

window.salvarPerfil = async () => {
  await setDoc(doc(db,"usuarios",usuarioAtual.uid),{
    nome:nome.value,
    interesses:interesses.value,
    dia:dia.value,
    mensagens:0,
    nivel:1
  });
  carregarUsuarios();
};

async function carregarUsuarios() {
  mostrar("usuarios");
  listaUsuarios.innerHTML="";
  const snap = await getDocs(collection(db,"usuarios"));
  snap.forEach(d=>{
    if(d.id!==usuarioAtual.uid){
      const div=document.createElement("div");
      div.innerText=d.data().nome+" ‚Äî "+d.data().interesses;
      div.onclick=()=>abrirChat(d.id,d.data().nome);
      listaUsuarios.appendChild(div);
    }
  });
}

function abrirChat(uid,nome){
  mostrar("chatBox");
  chatTitulo.innerText="Conversando com "+nome;
  chat.innerHTML="";
  chatId=[usuarioAtual.uid,uid].sort().join("_");

  const q=query(collection(db,"chats",chatId,"mensagens"),orderBy("data"));
  onSnapshot(q,s=>{
    chat.innerHTML="";
    s.forEach(m=>{
      const div=document.createElement("div");
      div.className="msg";
      div.innerText=m.data().texto;
      chat.appendChild(div);
    });
  });
}

window.enviarMensagem = async ()=>{
  if(!mensagem.value) return;
  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto:mensagem.value,
    data:Date.now()
  });

  const ref=doc(db,"usuarios",usuarioAtual.uid);
  const snap=await getDoc(ref);
  const total=(snap.data().mensagens||0)+1;
  const nivel= total>=200 ? 3 : total>=50 ? 2 : 1;

  await setDoc(ref,{mensagens:total,nivel:nivel},{merge:true});
  mensagem.value="";
};
</script>

</body>
</html>
